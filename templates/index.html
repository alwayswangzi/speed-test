<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏ãËΩΩÈÄüÂ∫¶ÊµãËØïÂ∑•ÂÖ∑</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }


        .test-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .test-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .latency-button {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .latency-button:hover {
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.6);
        }

        .website-test-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .website-test-button:hover {
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .test-status {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1em;
        }

        .status-label {
            font-weight: 600;
            color: #555;
        }

        .status-value {
            color: #333;
            font-weight: bold;
        }

        .status-value.running {
            color: #2196f3;
        }

        .status-value.completed {
            color: #4caf50;
        }

        .status-value.error {
            color: #f44336;
        }

        .result-card {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border-left: 5px solid #4caf50;
            display: none;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 1.2em;
        }

        .result-label {
            font-weight: 600;
            color: #2e7d32;
        }

        .result-value {
            color: #1b5e20;
            font-weight: bold;
        }

        .speed-display {
            font-size: 2em;
            color: #4caf50;
            font-weight: bold;
            margin: 20px 0;
        }

        .latency-card {
            background: #e8f4fd;
            border-left: 5px solid #2196f3;
        }

        .latency-card .result-label {
            color: #1565c0;
        }

        .latency-card .result-value {
            color: #0d47a1;
        }

        .latency-display {
            font-size: 2em;
            color: #2196f3;
            font-weight: bold;
            margin: 20px 0;
        }

        .website-test-card {
            background: #fff5f5;
            border-left: 5px solid #ff6b6b;
        }

        .website-test-card .result-label {
            color: #c62828;
        }

        .website-test-card .result-value {
            color: #b71c1c;
        }

        .website-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-label {
            font-weight: 600;
            color: #666;
        }

        .summary-value {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .website-list {
            margin-top: 20px;
        }

        .website-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #ddd;
        }

        .website-item.accessible {
            border-left-color: #4caf50;
        }

        .website-item.failed {
            border-left-color: #f44336;
        }

        .website-info {
            flex: 1;
        }

        .website-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .website-url {
            color: #666;
            font-size: 0.9em;
            word-break: break-all;
        }

        .website-status {
            text-align: right;
            min-width: 120px;
        }

        .status-accessible {
            color: #4caf50;
            font-weight: bold;
        }

        .status-failed {
            color: #f44336;
            font-weight: bold;
        }

        .response-time {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .error-message {
            color: #f44336;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .file-size-selector {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border-left: 5px solid #28a745;
        }

        .file-size-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .file-size-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .file-size-option:hover {
            border-color: #28a745;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.2);
        }

        .file-size-option.selected {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .file-size-option.selected::after {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 8px;
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
        }

        .file-size-label {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .file-size-desc {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ ‰∏ãËΩΩÈÄüÂ∫¶ÊµãËØïÂ∑•ÂÖ∑</h1>
        
        <div class="file-size-selector">
            <h3>üìÅ ÈÄâÊã©ÊµãËØïÊñá‰ª∂Â§ßÂ∞è</h3>
            <div class="file-size-options" id="fileSizeOptions">
                <!-- Êñá‰ª∂Â§ßÂ∞èÈÄâÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
            </div>
        </div>


        <div class="test-buttons">
            <button class="test-button" id="testButton" onclick="startCombinedTest()">
                üöÄ ÂºÄÂßãÁΩëÁªúÊµãËØï
            </button>
            <button class="test-button website-test-button" id="websiteTestButton" onclick="startWebsiteTest()">
                üåê ÊµãËØïÁΩëÁ´ôËøûÈÄöÊÄß
            </button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">ÂáÜÂ§áÊµãËØï...</p>
        </div>

        <div class="test-status" id="testStatus">
            <div class="status-item">
                <span class="status-label">üèì PingÊµãËØï:</span>
                <span class="status-value" id="pingStatus">Á≠âÂæÖ‰∏≠...</span>
            </div>
            <div class="status-item">
                <span class="status-label">üìä ‰∏ãËΩΩÊµãËØï:</span>
                <span class="status-value" id="speedStatus">Á≠âÂæÖ‰∏≠...</span>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="result-card" id="resultCard">
            <h3>üìä ‰∏ãËΩΩÈÄüÂ∫¶ÊµãËØïÁªìÊûú</h3>
            <div class="speed-display" id="speedDisplay"></div>
            <div class="result-item">
                <span class="result-label">‰∏ãËΩΩÊó∂Èó¥:</span>
                <span class="result-value" id="downloadTime"></span>
            </div>
            <div class="result-item">
                <span class="result-label">Êñá‰ª∂Â§ßÂ∞è:</span>
                <span class="result-value" id="fileSizeResult"></span>
            </div>
            <div class="result-item">
                <span class="result-label">Âπ≥ÂùáÈÄüÂ∫¶:</span>
                <span class="result-value" id="averageSpeed"></span>
            </div>
            <div class="result-item">
                <span class="result-label">Â≥∞ÂÄºÈÄüÂ∫¶:</span>
                <span class="result-value" id="peakSpeed"></span>
            </div>
        </div>

        <div class="result-card latency-card" id="pingResultCard">
            <h3>üèì PingÊµãËØïÁªìÊûú</h3>
            <div class="latency-display" id="pingDisplay"></div>
            <div class="result-item">
                <span class="result-label">ÊµãËØïÊ¨°Êï∞:</span>
                <span class="result-value" id="pingTestCount"></span>
            </div>
            <div class="result-item">
                <span class="result-label">ÊúÄÂ∞èÂª∂Ëøü:</span>
                <span class="result-value" id="minPing"></span>
            </div>
            <div class="result-item">
                <span class="result-label">ÊúÄÂ§ßÂª∂Ëøü:</span>
                <span class="result-value" id="maxPing"></span>
            </div>
            <div class="result-item">
                <span class="result-label">Âπ≥ÂùáÂª∂Ëøü:</span>
                <span class="result-value" id="avgPing"></span>
            </div>
            <div class="result-item">
                <span class="result-label">‰∏≠‰ΩçÊï∞Âª∂Ëøü:</span>
                <span class="result-value" id="medianPing"></span>
            </div>
            <div class="result-item">
                <span class="result-label">ÁΩëÁªúÊäñÂä®:</span>
                <span class="result-value" id="pingJitter"></span>
            </div>
        </div>

        <div class="result-card website-test-card" id="websiteTestResultCard">
            <h3>üåê ÁΩëÁ´ôËøûÈÄöÊÄßÊµãËØïÁªìÊûú</h3>
            <div class="website-summary" id="websiteSummary">
                <div class="summary-item">
                    <span class="summary-label">ÊÄªÊµãËØïÁΩëÁ´ô:</span>
                    <span class="summary-value" id="totalWebsites"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ÂèØËÆøÈóÆÁΩëÁ´ô:</span>
                    <span class="summary-value" id="accessibleWebsites"></span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Âπ≥ÂùáÂìçÂ∫îÊó∂Èó¥:</span>
                    <span class="summary-value" id="averageResponseTime"></span>
                </div>
            </div>
            <div class="website-list" id="websiteList">
                <!-- ÁΩëÁ´ôÊµãËØïÁªìÊûúÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>

    <script>
        let downloadStartTime = null;
        let downloadEndTime = null;
        let downloadedBytes = 0;
        let speedMeasurements = [];
        let selectedFileSize = '50m'; // ÈªòËÆ§ÈÄâÊã©50MB
        let availableSizes = [];
        let pingResults = []; // Â≠òÂÇ®pingÊµãËØïÁªìÊûú
        let websiteTestResults = null; // Â≠òÂÇ®ÁΩëÁ´ôÊµãËØïÁªìÊûú

        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÊñá‰ª∂Â§ßÂ∞èÈÄâÈ°π
        window.onload = function() {
            loadFileSizes();
        };

        async function loadFileSizes() {
            try {
                const response = await fetch('/speed-test/api/file-sizes');
                const data = await response.json();
                availableSizes = data.sizes;
                renderFileSizeOptions();
                selectFileSize('50m'); // ÈªòËÆ§ÈÄâÊã©50MB
            } catch (error) {
                showError('Êó†Ê≥ïÂä†ËΩΩÊñá‰ª∂Â§ßÂ∞èÈÄâÈ°π: ' + error.message);
            }
        }

        function renderFileSizeOptions() {
            const container = document.getElementById('fileSizeOptions');
            container.innerHTML = '';
            
            availableSizes.forEach(size => {
                const option = document.createElement('div');
                option.className = 'file-size-option';
                option.onclick = (event) => selectFileSize(size.key, event.target);
                
                option.innerHTML = `
                    <div class="file-size-label">${size.display_name}</div>
                    <div class="file-size-desc">${getSizeDescription(size.key)}</div>
                `;
                
                container.appendChild(option);
            });
        }

        function getSizeDescription(key) {
            const descriptions = {
                '1m': 'Âø´ÈÄüÊµãËØï',
                '10m': 'Ê†áÂáÜÊµãËØï',
                '50m': 'ËØ¶ÁªÜÊµãËØï',
                '100m': 'ÂéãÂäõÊµãËØï'
            };
            return descriptions[key] || '';
        }

        function selectFileSize(sizeKey, targetElement = null) {
            selectedFileSize = sizeKey;
            
            // Êõ¥Êñ∞UIÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.file-size-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Â¶ÇÊûúÊèê‰æõ‰∫ÜÁõÆÊ†áÂÖÉÁ¥†Ôºå‰ΩøÁî®ÂÆÉÔºõÂê¶ÂàôÈÄöËøákeyÊü•Êâæ
            let targetOption;
            if (targetElement) {
                targetOption = targetElement.closest('.file-size-option');
            } else {
                // ÈÄöËøákeyÊü•ÊâæÂØπÂ∫îÁöÑÈÄâÈ°π
                const options = document.querySelectorAll('.file-size-option');
                const sizeIndex = availableSizes.findIndex(s => s.key === sizeKey);
                if (sizeIndex >= 0 && options[sizeIndex]) {
                    targetOption = options[sizeIndex];
                }
            }
            
            if (targetOption) {
                targetOption.classList.add('selected');
            }
            
            // Êñá‰ª∂Â§ßÂ∞èÈÄâÊã©ÂÆåÊàê
        }


        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatSpeed(bytesPerSecond) {
            if (bytesPerSecond === 0) return '0 B/s';
            const k = 1024;
            const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
            const i = Math.floor(Math.log(bytesPerSecond) / Math.log(k));
            return parseFloat((bytesPerSecond / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            if (seconds < 1) {
                return (seconds * 1000).toFixed(0) + ' ms';
            } else if (seconds < 60) {
                return seconds.toFixed(2) + ' Áßí';
            } else {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return minutes + ' ÂàÜ ' + remainingSeconds.toFixed(2) + ' Áßí';
            }
        }

        async function startCombinedTest() {

            const testButton = document.getElementById('testButton');
            const progressContainer = document.getElementById('progressContainer');
            const testStatus = document.getElementById('testStatus');
            const resultCard = document.getElementById('resultCard');
            const pingResultCard = document.getElementById('pingResultCard');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const pingStatus = document.getElementById('pingStatus');
            const speedStatus = document.getElementById('speedStatus');

            // ÈáçÁΩÆÁä∂ÊÄÅ
            testButton.disabled = true;
            testButton.innerHTML = '<span class="loading"></span>ÁΩëÁªúÊµãËØï‰∏≠...';
            progressContainer.style.display = 'block';
            testStatus.style.display = 'block';
            resultCard.style.display = 'none';
            pingResultCard.style.display = 'none';
            progressFill.style.width = '0%';
            progressText.textContent = 'ÂáÜÂ§áÁΩëÁªúÊµãËØï...';
            
            // ÈáçÁΩÆÁä∂ÊÄÅÊòæÁ§∫
            pingStatus.textContent = 'Á≠âÂæÖ‰∏≠...';
            pingStatus.className = 'status-value';
            speedStatus.textContent = 'Á≠âÂæÖ‰∏≠...';
            speedStatus.className = 'status-value';

            // ÈáçÁΩÆÊµãÈáèÊï∞ÊçÆ
            downloadStartTime = null;
            downloadEndTime = null;
            downloadedBytes = 0;
            speedMeasurements = [];
            pingResults = [];

            let pingTestCompleted = false;
            let speedTestCompleted = false;

            try {
                // ÂêåÊó∂ÂºÄÂßã‰∏§‰∏™ÊµãËØï
                const pingPromise = runPingTest();
                const speedPromise = runSpeedTest();

                // Á≠âÂæÖ‰∏§‰∏™ÊµãËØïÂÆåÊàê
                const [pingResult, speedResult] = await Promise.allSettled([pingPromise, speedPromise]);

                // Â§ÑÁêÜpingÊµãËØïÁªìÊûú
                if (pingResult.status === 'fulfilled') {
                    displayPingResults(pingResult.value);
                    pingStatus.textContent = 'ÂÆåÊàê';
                    pingStatus.className = 'status-value completed';
                } else {
                    pingStatus.textContent = 'Â§±Ë¥•';
                    pingStatus.className = 'status-value error';
                    console.error('PingÊµãËØïÂ§±Ë¥•:', pingResult.reason);
                }

                // Â§ÑÁêÜ‰∏ãËΩΩÊµãËØïÁªìÊûú
                if (speedResult.status === 'fulfilled') {
                    const { totalTime, downloadedBytes, averageSpeed, peakSpeed } = speedResult.value;
                    displayResults(totalTime, downloadedBytes, averageSpeed, peakSpeed);
                    speedStatus.textContent = 'ÂÆåÊàê';
                    speedStatus.className = 'status-value completed';
                } else {
                    speedStatus.textContent = 'Â§±Ë¥•';
                    speedStatus.className = 'status-value error';
                    console.error('‰∏ãËΩΩÊµãËØïÂ§±Ë¥•:', speedResult.reason);
                }

                // Êõ¥Êñ∞ËøõÂ∫¶
                progressFill.style.width = '100%';
                progressText.textContent = 'ÁΩëÁªúÊµãËØïÂÆåÊàêÔºÅ';

            } catch (error) {
                showError('ÁΩëÁªúÊµãËØïÂ§±Ë¥•: ' + error.message);
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                testButton.disabled = false;
                testButton.innerHTML = 'üöÄ ÈáçÊñ∞ÂºÄÂßãÁΩëÁªúÊµãËØï';
            }
        }

        async function runPingTest() {
            const pingStatus = document.getElementById('pingStatus');
            pingStatus.textContent = 'ÊµãËØï‰∏≠...';
            pingStatus.className = 'status-value running';
            
            const pings = [];
            const testCount = 5; // pingÊµãËØïÊ¨°Êï∞
            
            // Ëé∑ÂèñÂΩìÂâçÈ°µÈù¢ÁöÑ‰∏ªÊú∫ÂêçÂíåÁ´ØÂè£
            const hostname = window.location.hostname;
            const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            const protocol = window.location.protocol;
            const baseUrl = `${protocol}//${hostname}${port ? ':' + port : ''}`;
            
            console.log(`ÂºÄÂßãpingÊµãËØïÂà∞: ${baseUrl}`);
            
            for (let i = 0; i < testCount; i++) {
                try {
                    const startTime = performance.now();
                    const response = await fetch(`${baseUrl}/speed-test/api/ping`);
                    const endTime = performance.now();
                    
                    if (response.ok) {
                        const pingTime = endTime - startTime;
                        pings.push(pingTime);
                        console.log(`Ping ${i + 1}: ${pingTime.toFixed(2)}ms`);
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    // Áü≠ÊöÇÂª∂ËøüÈÅøÂÖçËøá‰∫éÈ¢ëÁπÅÁöÑËØ∑Ê±Ç
                    if (i < testCount - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                } catch (error) {
                    console.error(`Ping ${i + 1} Â§±Ë¥•:`, error);
                    throw new Error(`PingÊµãËØïÂ§±Ë¥•: ${error.message}`);
                }
            }
            
            // ËÆ°ÁÆóÁªüËÆ°‰ø°ÊÅØ
            const stats = calculatePingStats(pings);
            
            return {
                test_count: testCount,
                pings: pings,
                statistics: stats,
                timestamp: new Date().toISOString()
            };
        }
        
        function calculatePingStats(pings) {
            if (!pings || pings.length === 0) {
                return {
                    min: 0,
                    max: 0,
                    avg: 0,
                    median: 0,
                    jitter: 0
                };
            }
            
            const sortedPings = [...pings].sort((a, b) => a - b);
            const min = sortedPings[0];
            const max = sortedPings[sortedPings.length - 1];
            const avg = pings.reduce((sum, ping) => sum + ping, 0) / pings.length;
            
            // ËÆ°ÁÆó‰∏≠‰ΩçÊï∞
            const n = sortedPings.length;
            const median = n % 2 === 0 
                ? (sortedPings[n/2 - 1] + sortedPings[n/2]) / 2
                : sortedPings[Math.floor(n/2)];
            
            // ËÆ°ÁÆóÊäñÂä®ÔºàÊ†áÂáÜÂ∑ÆÔºâ
            const variance = pings.reduce((sum, ping) => sum + Math.pow(ping - avg, 2), 0) / pings.length;
            const jitter = Math.sqrt(variance);
            
            return {
                min: Math.round(min * 100) / 100,
                max: Math.round(max * 100) / 100,
                avg: Math.round(avg * 100) / 100,
                median: Math.round(median * 100) / 100,
                jitter: Math.round(jitter * 100) / 100
            };
        }

        async function runSpeedTest() {
            const speedStatus = document.getElementById('speedStatus');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            speedStatus.textContent = 'ÊµãËØï‰∏≠...';
            speedStatus.className = 'status-value running';
            
            // ÂºÄÂßã‰∏ãËΩΩÔºå‰º†ÈÄíÊñá‰ª∂Â§ßÂ∞èÂèÇÊï∞
            const response = await fetch(`/speed-test/download?size=${selectedFileSize}`);
            const reader = response.body.getReader();
            const contentLength = parseInt(response.headers.get('content-length') || '0');

            downloadStartTime = performance.now();
            progressText.textContent = 'Ê≠£Âú®‰∏ãËΩΩ...';

            while (true) {
                const { done, value } = await reader.read();
                
                if (done) break;

                downloadedBytes += value.length;
                const progress = (downloadedBytes / contentLength) * 50; // ‰∏ãËΩΩÊµãËØïÂç†50%ËøõÂ∫¶
                progressFill.style.width = progress + '%';
                progressText.textContent = `‰∏ãËΩΩ‰∏≠... ${progress.toFixed(1)}%`;

                // ËÆ∞ÂΩïÈÄüÂ∫¶ÊµãÈáè
                const currentTime = performance.now();
                if (downloadStartTime) {
                    const elapsedTime = (currentTime - downloadStartTime) / 1000; // ËΩ¨Êç¢‰∏∫Áßí
                    if (elapsedTime > 0) {
                        const currentSpeed = downloadedBytes / elapsedTime;
                        speedMeasurements.push(currentSpeed);
                    }
                }
            }

            downloadEndTime = performance.now();
            const totalTime = (downloadEndTime - downloadStartTime) / 1000;
            const averageSpeed = downloadedBytes / totalTime;
            const peakSpeed = Math.max(...speedMeasurements);

            return { totalTime, downloadedBytes, averageSpeed, peakSpeed };
        }

        function displayResults(totalTime, fileSize, averageSpeed, peakSpeed) {
            const resultCard = document.getElementById('resultCard');
            const speedDisplay = document.getElementById('speedDisplay');
            const downloadTime = document.getElementById('downloadTime');
            const fileSizeResult = document.getElementById('fileSizeResult');
            const averageSpeedElement = document.getElementById('averageSpeed');
            const peakSpeedElement = document.getElementById('peakSpeed');

            speedDisplay.textContent = formatSpeed(averageSpeed);
            downloadTime.textContent = formatTime(totalTime);
            fileSizeResult.textContent = formatBytes(fileSize);
            averageSpeedElement.textContent = formatSpeed(averageSpeed);
            peakSpeedElement.textContent = formatSpeed(peakSpeed);

            resultCard.style.display = 'block';
        }

        function displayPingResults(data) {
            const pingResultCard = document.getElementById('pingResultCard');
            const pingDisplay = document.getElementById('pingDisplay');
            const pingTestCount = document.getElementById('pingTestCount');
            const minPing = document.getElementById('minPing');
            const maxPing = document.getElementById('maxPing');
            const avgPing = document.getElementById('avgPing');
            const medianPing = document.getElementById('medianPing');
            const pingJitter = document.getElementById('pingJitter');

            const stats = data.statistics;
            
            pingDisplay.textContent = stats.avg + ' ms';
            pingTestCount.textContent = data.test_count + ' Ê¨°';
            minPing.textContent = stats.min + ' ms';
            maxPing.textContent = stats.max + ' ms';
            avgPing.textContent = stats.avg + ' ms';
            medianPing.textContent = stats.median + ' ms';
            pingJitter.textContent = stats.jitter + ' ms';

            pingResultCard.style.display = 'block';
            
            console.log('PingÊµãËØïÁªìÊûú:', data);
        }

        async function startWebsiteTest() {
            const websiteTestButton = document.getElementById('websiteTestButton');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const websiteTestResultCard = document.getElementById('websiteTestResultCard');

            // ÈáçÁΩÆÁä∂ÊÄÅ
            websiteTestButton.disabled = true;
            websiteTestButton.innerHTML = '<span class="loading"></span>ÊµãËØïÁΩëÁ´ôËøûÈÄöÊÄß‰∏≠...';
            progressContainer.style.display = 'block';
            websiteTestResultCard.style.display = 'none';
            progressFill.style.width = '0%';
            progressText.textContent = 'ÂáÜÂ§áÊµãËØïÁΩëÁ´ôËøûÈÄöÊÄß...';

            try {
                // ÂºÄÂßãÁΩëÁ´ôËøûÈÄöÊÄßÊµãËØï
                progressFill.style.width = '50%';
                progressText.textContent = 'Ê≠£Âú®ÊµãËØïÁΩëÁ´ôËøûÈÄöÊÄß...';
                
                const response = await fetch('/speed-test/api/website-test');
                const data = await response.json();
                
                if (response.ok) {
                    websiteTestResults = data;
                    displayWebsiteTestResults(data);
                    
                    progressFill.style.width = '100%';
                    progressText.textContent = 'ÁΩëÁ´ôËøûÈÄöÊÄßÊµãËØïÂÆåÊàêÔºÅ';
                } else {
                    throw new Error(data.error || 'ÁΩëÁ´ôËøûÈÄöÊÄßÊµãËØïÂ§±Ë¥•');
                }
                
            } catch (error) {
                showError('ÁΩëÁ´ôËøûÈÄöÊÄßÊµãËØïÂ§±Ë¥•: ' + error.message);
                progressText.textContent = 'ÁΩëÁ´ôËøûÈÄöÊÄßÊµãËØïÂ§±Ë¥•';
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                websiteTestButton.disabled = false;
                websiteTestButton.innerHTML = 'üåê ÈáçÊñ∞ÊµãËØïÁΩëÁ´ôËøûÈÄöÊÄß';
            }
        }

        function displayWebsiteTestResults(data) {
            const websiteTestResultCard = document.getElementById('websiteTestResultCard');
            const totalWebsites = document.getElementById('totalWebsites');
            const accessibleWebsites = document.getElementById('accessibleWebsites');
            const averageResponseTime = document.getElementById('averageResponseTime');
            const websiteList = document.getElementById('websiteList');

            // ÊòæÁ§∫Ê±áÊÄª‰ø°ÊÅØ
            const summary = data.summary;
            totalWebsites.textContent = summary.total + ' ‰∏™';
            accessibleWebsites.textContent = summary.accessible + ' ‰∏™';
            averageResponseTime.textContent = summary.average_response_time ? 
                summary.average_response_time + ' ms' : 'N/A';

            // ÁîüÊàêÁΩëÁ´ôÂàóË°®
            websiteList.innerHTML = '';
            for (const [key, website] of Object.entries(data.websites)) {
                const websiteItem = document.createElement('div');
                websiteItem.className = `website-item ${website.accessible ? 'accessible' : 'failed'}`;
                
                const statusClass = website.accessible ? 'status-accessible' : 'status-failed';
                const statusText = website.accessible ? 'ÂèØËÆøÈóÆ' : 'Êó†Ê≥ïËÆøÈóÆ';
                const responseTimeText = website.accessible ? 
                    `ÂìçÂ∫îÊó∂Èó¥: ${website.response_time_ms} ms` : 
                    `ÈîôËØØ: ${website.error || 'Êú™Áü•ÈîôËØØ'}`;
                
                websiteItem.innerHTML = `
                    <div class="website-info">
                        <div class="website-name">${website.name}</div>
                        <div class="website-url">${website.url}</div>
                    </div>
                    <div class="website-status">
                        <div class="${statusClass}">${statusText}</div>
                        <div class="${website.accessible ? 'response-time' : 'error-message'}">${responseTimeText}</div>
                    </div>
                `;
                
                websiteList.appendChild(websiteItem);
            }

            // ÊòæÁ§∫ÁªìÊûúÂç°Áâá
            websiteTestResultCard.style.display = 'block';
            
            console.log('ÁΩëÁ´ôËøûÈÄöÊÄßÊµãËØïÁªìÊûú:', data);
        }
    </script>
</body>
</html>
